# WebApp

后端需要修改的内容


## handlers.h

boost::json::object list_users(
    std::shared_ptr<bserv::db_connection> conn,
    std::shared_ptr<bserv::session_type> session_ptr,
    const std::string& s_page_id);


## handlers.cpp

boost::json::object list_users(
	std::shared_ptr<bserv::db_connection> conn,
	std::shared_ptr<bserv::session_type> session_ptr,
	const std::string& s_page_id) {
	int page_id = std::stoi(s_page_id);
	lgdebug << "view users: " << page_id << std::endl;
	bserv::db_transaction tx{ conn };
	bserv::db_result db_res = tx.exec("select count(*) from auth_user where is_active;");
	lginfo << db_res.query();
	std::size_t total_users = (*db_res.begin())[0].as<std::size_t>();
	lgdebug << "total users: " << total_users << std::endl;
	int total_pages = (int)total_users / 10;
	if (total_users % 10 != 0) ++total_pages;
	lgdebug << "total pages: " << total_pages << std::endl;
	db_res = tx.exec(
		"select u.id, u.username, u.password, u.is_superuser, u.first_name, u.last_name, u.email, u.is_active "
		"from auth_user u "
		"where u.is_active "
		"group by u.id, u.username, u.password, u.is_superuser, u.first_name, u.last_name, u.email, u.is_active "
		"limit 10 offset ?;",
		(page_id - 1) * 10);
	lginfo << db_res.query();
	auto users = orm_user.convert_to_vector(db_res);
	boost::json::array json_users;
	for (auto& user : users) {
		user.erase("id");
		user.erase("password");
		json_users.push_back(user);
	}
	return { {"users", json_users}, {"total_users", total_users}, {"total_pages", total_pages} };
}


## WebApp.cpp

注册路由：
		bserv::make_path("/users/list/<int>", &list_users,
			bserv::placeholders::db_connection_ptr,
			bserv::placeholders::session,
			bserv::placeholders::_1),
